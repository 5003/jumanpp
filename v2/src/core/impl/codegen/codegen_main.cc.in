//
// Created by Arseny Tolmachev on 2017/05/26.
//

#include <iostream>
#include "core/spec/spec_dsl.h"
#include "core/impl/feature_codegen.h"
#include "core/dic/dic_builder.h"
#include "core/dic/dictionary.h"
#include "core/core.h"
#include "util/csv_reader.h"
#include "${CG_SPEC_INCLUDE}"

namespace cg = jumanpp::core::features::codegen;

int main(int argc, char** argv) {
  if (argc != 4 && argc != 5) {
    std::cerr << "Number of arguments (" << argc - 1 << ") was not 3 or 4\n";
    return 1;
  }

  cg::FeatureCodegenConfig conf;
  conf.filename = argv[1];
  conf.className = argv[2];
  conf.baseDirectory = argv[3];

  jumanpp::core::spec::dsl::ModelSpecBuilder bldr;
  ${CG_SPEC_NAME} ::fillSpec(bldr);

  jumanpp::core::spec::AnalysisSpec spec;
  auto s = bldr.build(&spec);
  if (!s) {
    std::cerr << "failed to build spec: " << s;
    return 1;
  }

  jumanpp::core::dic::DictionaryBuilder dbld;
  s = dbld.importSpec(&spec);
  if (argc == 5) {
    auto inputFile = jumanpp::StringPiece::fromCString(argv[4]);
    jumanpp::util::FullyMappedFile fmf;
    s = fmf.open(inputFile);
    if (!s) {
      std::cerr << "failed to open raw dictionary file: " << inputFile << "\n";
      return 1;
    }
    s = dbld.importCsv(inputFile, fmf.contents());
  } else {
    s = dbld.importCsv("none", "");
  }

  if (!s) {
    std::cerr << "failed to import empty dic: " << s;
    return 1;
  }

  jumanpp::core::dic::DictionaryHolder dh;
  if (!(s = dh.load(dbld.result()))) {
    std::cerr << "failed to build dicholder " << s;
    return 1;
  }

  jumanpp::core::RuntimeInfo runtimeInfo;
  if (!dh.compileRuntimeInfo(spec, &runtimeInfo)) {
    return 1;
  }

  jumanpp::core::CoreHolder ch{runtimeInfo, dh};

  jumanpp::core::features::FeatureHolder fh;

  if (!(s = jumanpp::core::features::makeFeatures(ch, nullptr, &fh))) {
    std::cerr << "failed to make features: " << s;
    return 1;
  }

  cg::StaticFeatureCodegen sfc{conf};

  s = sfc.generateAndWrite(fh);
  if (!s) {
    std::cerr << "failed to create static files for " << conf.filename << ": " << s;
    return 1;
  }

  return 0;
}